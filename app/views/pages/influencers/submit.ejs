<!Doctype html>
<html>
    <head>
        <% include ../../partials/head %>
        <link  href="/stylesheets/cropper.min.css" rel="stylesheet">
        <script src="/javascripts/cropper.min.js"></script>
    </head>
    <body>
        <% include ../../partials/header %>
        <% include ../../partials/nav %>
        
        <div class='container-fluid '>
            <h1>New&nbsp;Listing</h1>
                <div class="row justify-content-center">
                    <form id='submit-pic-form' class='bg-grey col-md-12 pt-4' action='/influencers/submit' method='post'>
                        <div class='form-group pl-3 pr-3' id = "fieldsDiv">
                            <select name='type' class='form-control col-md-3 border-pink' required>
                                <%- include('../../partials/option', {value: 'Individual Item', placeholder: 'Individual Item', name: 'type', selected: false}) %>
                                <%- include('../../partials/option', {value: 'Bundle of Items', placeholder: 'Bundle of Items', name: 'type', selected: false}) %>
                            </select>    
                        </div>
                        <div class='form-group pl-3 pr-3' id = "fieldsDiv">
                            <%- include('../../partials/input', {name: 'item', classes: 'form-control border-pink  col-md-3', type: 'text', id: '', placeholder: 'Item *', min: '', max: '', required: true, value: ''}) %>
                        </div>

                        <div class='form-group pl-3 pr-3' id = "fieldsDiv">
                            <%- include('../../partials/input', {name: 'size', classes: 'form-control border-pink col-md-3', type: 'text', id: '', placeholder: 'Size *', min: '', max: '', required: true, value: ''}) %>
                        </div>

                        <div class='form-group pl-3 pr-3' id = "fieldsDiv">
                            <%- include('../../partials/input', {name: 'brand', classes: 'form-control border-pink col-md-3', type: 'text', id: '', placeholder: 'Brand *', min: '', max: '', required: true, value: ''}) %>
                        </div>

                        <div class='form-group form-inline pl-3 pr-3' id = "fieldsDiv">
                            <input name='selling_price' onchange="updateFinal" class='form-control border-pink col-md-3 mr-md-2 mt-2' id="selling-price" type='number' step = 0.01 placeholder='Selling Price *' min='40' max='' value=''>
                            <!-- Will change this shipping price -->
                            <input name='shipping_price' onchange="updateFinal" class='form-control border-pink col-md-2 mr-md-2 mt-2' id="shipping-price" type='number' step = 0.01 placeholder='Shipping Cost *' min='40' max='' value=''>
                            <input name='final_price' class='form-control border-pink col-md-2 mt-2' id="final-price" type='text' placeholder='Final Price *' value='' readonly>
                        </div>

                        <div class='form-group pl-3 pr-3' id = "fieldsDiv">
                            <input name='earnings' class='form-control border-pink col-md-3' id="earnings" type='text' placeholder='Earnings from this sale *' value='' readonly>
                            <small class="form-text text-muted text-left">75% of the selling price</small>
                        </div>

                        <div class='form-group pl-3 pr-3' id = "fieldsDiv">
                            <%- include('../../partials/input', {name: 'original_price', classes: 'form-control border-pink col-md-3', type: 'number', id: '', placeholder: 'Original Price *', min: 0, max: '', required: true, value: ''}) %>
                            <small class="form-text text-muted text-left">Just as a reference to the shoppers</small>
                        </div>


                        <div class='form-group pl-3 pr-3' id = "fieldsDiv">
                            <select name='condition' class='form-control col-md-3 border-pink' required>
                                <%- include('../../partials/option', {value: 'New with tags (Never worn, tags attached)', placeholder: 'New', name: 'condition', selected: false}) %>
                                <%- include('../../partials/option', {value: 'Excellent (Worn just a few times, looks as new)', placeholder: 'Excellent', name: 'condition', selected: false}) %>
                                <%- include('../../partials/option', {value: 'Very Good (Worn, but still looks great)', placeholder: 'Very Good', name: 'condition', selected: false}) %>
                                <%- include('../../partials/option', {value: 'Good (Found tiny flaws, which I noted in my listing and made visible in my pictures)', placeholder: 'Good', name: 'condition', selected: false}) %>
                                <%- include('../../partials/option', {value: 'Satisfactory (It has some flaws, all noted in the description and visible in pics)', placeholder: 'Satisfactory', name: 'condition', selected: false}) %>
                            </select>
                        </div>

                        <div class='form-group pl-3 pr-3' id = "fieldsDiv">
                            <textarea name="description" class = 'form-control border-pink desc col-md-3' rows = "4" placeholder = "Description: Here you can add any comment you would like about the item you are selling (optional)"></textarea>  
                        </div>


                        <div class='form-group pl-3 pr-3'>
                            <button type="submit" id = "createPost" class="btn btn-pink btn-primary text-center col-md-3" >Create Post</button>
                        </div>

                        <hr>
                        <h3> Images </h3>

                        <div class = 'card-group pl-3 pr-3' id = "thumbnails"></div>

                        <hr>
                        <h3> Add New Image </h3>

                        <div class='form-group pl-3 pr-3'>
                            <div class="col-md-4">
                                <input type="file" id="photo-upload" name="photo-upload" class="custom-file-input" accept="image/*">
                                <small class="form-text text-muted text-left">You may upload up to 10 images in a post.</small>
                                <label class="custom-file-label text-left" for="customFile">Choose file</label>
                                <input type="text" id="photo-upload-hidden" name="img_urls" class="form-control border-pink" hidden>
                            </div>
                        </div>

                        <!-- Render thumbnails for cropped images -->

                        <div id = "imgDiv" class='container mx-auto' style='width: 500px; height: 500px;'></div>     
                    </form>
                </div>           
            </div>    
        </div>

        <script>            
            const $selling = document.querySelector('#selling-price');
            const $shipping = document.querySelector('#shipping-price');
            const $final = document.querySelector('#final-price');
            const $earning = document.querySelector('#earnings');
            $selling.addEventListener('input', updateFinal)
            $shipping.addEventListener('input', updateFinal)

            function updateFinal() {
                var selling = $selling.value ? parseFloat($selling.value) : 0.;
                var shipping = $shipping.value ? parseFloat($shipping.value) : 0.;
                $final.value = Math.round((selling + shipping) * 100) / 100;
                $earning.value = Math.round(selling * 0.75 * 100) / 100;
            }

            //used for custom upload file button to get file  
            function FileSelected(e)
            {
                file = document.getElementById('photo-upload').files[document.getElementById('photo-upload').files.length - 1];
            }
            //Description text box will populate placeholder when out of focus.
            $(function(){
    
                $('.desc').data('holder',$('.desc').attr('placeholder'));
    
                $('.desc').focusin(function(){
                $(this).attr('placeholder','');
                });
                $('.desc').focusout(function(){
                    $(this).attr('placeholder',$(this).data('holder'));
                });
    
                $('#thumbnails').on("click", '.notify-badge', function(event){
                    // Remove image from display
                    event.target.parentElement.parentElement.remove();
                    // Remove image URL
                    document.getElementById('photo-upload-hidden').value = document.getElementById('photo-upload-hidden').value.replace(event.target.parentElement.dataset.imgUrl + ',', '');
                });
            })
            //will append a new line of form fields if 'add line' is clicked, or deletes a line if 'delete line' clicked
            //Takes in boolean to denote whether its an add or drop operation
            // var num;
            // var last;

            // function appendFormFields(){
            //     var fields = document.querySelector('#fieldsDiv');

            //     last = fields.cloneNode(true)
            //     document.getElementById('formFieldsDiv').appendChild(last);
            //     $('#formFieldsDiv button').show();
                
            // }

            // function deleteRow(){
            //     $(this).parent().remove();
            // }

            // function checkFile(img) {
            //     var reader = new FileReader();
            //     reader.onload = function(e) {
            //         $('#image-source').attr('src', e.target.result);
            //     }
            //     reader.readAsDataURL(img);
            // }
            
            //help info for uploading images
            $("#photo-upload-button").hover(function(){
                $('#uploadHelp').append("<small class='form-text text-danger'>You may upload/crop up to 10 images in one post. <br> Upload and crop one picture at a time.</small>")
            }, function(){
                $('#uploadHelp').empty();
            });

            //image cropping and saving image
            var img1;
            var cropper;
            var imgDiv = $("#imgDiv");
            imgDiv.hide();
            $("input[type='file']").on("change", function(event1) {
                src1 = URL.createObjectURL(event1.target.files[0]);
                img1 = new Image(); //html image element passed into cropper.js
                img1.src = src1;

                $('#imgDiv').append("<button type = 'button' id = 'doneCropping' class = 'btn btn-pink btn-primary text-center'>Done Cropping</button>")
                $('#imgDiv').append(img1); //wrap img in container
                $("#photo-upload").attr("disabled", "disabled"); // Disable file upload until image cropped and uploaded
                $("#createPost").attr("disabled", "disabled"); // Disable form submit until image cropped and uploaded
                imgDiv.show();

                //done cropping button event handler
                $('#doneCropping').on("click", function(){
                    var croppedCanvas = cropper.getCroppedCanvas({
                        width: 160,
                        height: 90,
                        minWidth: 250, //set min contraints
                        minHeight: 250,
                        maxWidth: 1080, //set max constraints based on Instagram
                        maxHeight: 1080,
                        fillColor: '#fff',
                        imageSmoothingEnabled: false,
                        imageSmoothingQuality: 'high',
                    });
                

                    var hidden = document.getElementById('photo-upload-hidden');
                    
                    //created in case this is what's passed on form submit
                    var croppedImage = new Image();
                    //javascript image with src assigned from user cropped image.
                    croppedImage.src = croppedCanvas.toDataURL("image/png")

                    //get blob to send to server
                    croppedCanvas.toBlob(function(blob){
                        var formData = new FormData();
                        // Get the original pictures names without extension
                        var filename = document.getElementById('photo-upload').value.split(/(\\|\/)/g).pop().split('.').slice(0, -1).join('.');
                        formData.append('croppedImage', blob, filename + '.png');
                        $.ajax('/influencers/uploadPhoto', {
                            method: "POST",
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function(response) {
                                console.log('Upload success');
                                document.getElementById('photo-upload-hidden').value += response + ",";
                                document.getElementById('photo-upload').value = null;
                                $("#createPost").removeAttr("disabled"); // Allow form submit
                                $("#photo-upload").removeAttr("disabled"); // Allow file upload

                                //Add thumbnail of cropped image to page

                                $('#thumbnails').append(`
                                    <div class="item mr-4">
                                        <span class="notify-badge" data-img-url='${response}'>
                                            <button type="button" class="btn btn-danger btn-sm">Delete</button>
                                        </span>
                                        <img class='img-thumbnail' src = '${response}'/>
                                    </div>
                                `);

                                if ($('.img-thumbnail').length >= 10) {
                                    $("input[type='file']").attr("disabled", "disabled");
                                }
                            },
                            error() {
                                console.log('Upload error');
                            },
                        });

                    }, 'image/png', .95) //convert to PNG at 95% quality 

                    //clear UI for next image crop if need be
                    $('#imgDiv').empty();
                    imgDiv.hide();
                });

                cropper = new Cropper(img1, {
                    aspectRatio: 1/1,
                    crop(event){
                    },
                    viewMode: 1,
                    minCropBoxWidth: 250,
                    minCropBoxHeight: 250,
                    maxCropBoxHeight:1080,
                    maxCropBoxWidth: 1080,
                });
            });

            $('#createPost').click(function(event){
                
                var temp = document.getElementById('photo-upload-hidden').value
                if(temp.length == 0){
                    event.preventDefault();
                    $('#uploadHelp').append("<small class='form-text text-danger'>You must upload atleast one picture for a post.</small>")
                    
                }
            })
        </script>

        <% include ../../partials/footer %>
    </body>
</html>
